name: OnStream to GDrive Bot
on:
  workflow_dispatch:

jobs:
  run-bot:
    runs-on: ubuntu-latest # අපි නැවත ස්ථාවර Linux Server එකට යමු
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Rclone
        run: |
          sudo apt-get install rclone -y
          mkdir -p ~/.config/rclone
          echo "${{ secrets.RCLONE_CONFIG_DATA }}" > ~/.config/rclone/rclone.conf

      - name: Setup Emulator and Run Bot
        uses: reactivecircus/android-emulator-runner@v2
        with:
          # Android 12 (API 31) මගින් ARM APKs x86 මත ධාවනය කිරීමට ඉඩ දෙයි
          api-level: 31
          target: google_apis
          arch: x86_64
          force-avd-creation: false
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none
          disable-animations: true
          script: |
            # Emulator එක හොඳින් පණගැන්වෙන තෙක් රැඳී සිටීම
            adb wait-for-device
            
            # APK එක බාගත කිරීම
            curl -L "https://dl2.getmenow.click/setup/onstream/5892616/onstream-android.apk" -o onstream.apk
            
            # APK එක ස්ථාපනය (API 31 නිසා මෙය දැන් Success විය යුතුයි)
            adb install onstream.apk
            
            # ඇප් එකට සූදානම් වීමට තත්පර 10ක්
            sleep 10
            
            # Python බොට් එක පණගැන්වීම
            python3 bot_script.py
        env:
          RCLONE_CONFIG_DATA: ${{ secrets.RCLONE_CONFIG_DATA }}
          TG_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
